---
title: "openNCAreport Basic Walkthrough"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{basic_walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Load package

```{r setup}
library(openNCAreport)
```

## Set input parameters

```{r params}
profile <- "SDEID"
tc_path <- system.file("test_data", package = "openNCAreport") # this is an example case
flag <- "FLGACCEPTKEL"
by <- "TREATXT"
```

## Loading a test case

```{r loadtc}
tc <- load_test_case(tc_path)
# get working dataset
get_wds(tc)
```

## Assigning parameter labels

```{r labels}
tc <- tc %>% assign_wds_labels()
```

## Filter exclusions

```{r excl}
tc <- tc %>%
      filter_wds_exclusions(flg = flag,
                            profile = profile,
                            by = by)
```

## Select summary paramters

```{r select}
tc <- select_wds_pars(tc,
                      dplyr::all_of(by), # use all_of() here as we are selecting with a string
                      CMAX1,
                      TMAX1,
                      MRTP,
                      THALF)
```

## Use {gtsummary} to produce exclusion and parameter summary and stack the tables for display

```{r gts}

Nn <- tc$exclusions %>%
      dplyr::select(-dplyr::all_of(profile)) %>%
      gtsummary::tbl_summary(by = dplyr::all_of(by),
                             type = list(EXCL ~ 'continuous'),
                             statistic = c(EXCL ~ "{length}, {little_n}"),
                             digits = c(EXCL ~ 0),
                             label = c(EXCL ~"N, n")) %>%
           # remove autogenerated footnote
           gtsummary::modify_footnote(dplyr::everything() ~ NA)

gts_tab <- tc$WDS %>%
           gtsummary::tbl_summary(by = dplyr::all_of(by),
                                  type = list(TMAX1 ~ 'continuous',
                                              THALF ~ 'continuous',
                                              MRTP ~ 'continuous'),
                                  statistic = c(
                                     TMAX1 ~ "{median} ({lower_range}-{upper_range})",
                                     THALF ~ "{mean} &plusmn {sd}",
                                     MRTP ~ "{mean} &plusmn {sd}"
                                     )) %>%
           gtsummary::modify_footnote(dplyr::everything() ~ NA)

# stack the tables one on the other and render as HTML
gtsummary::tbl_stack(list(Nn, gts_tab)) %>%
  gtsummary::as_gt() %>%
  # this informs {gt} to render in HTML
  gt::fmt(columns = dplyr::everything(), fns = function(x) x)
```
